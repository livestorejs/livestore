echo "DEBUG 1: .envrc loaded"

# Fail on errors
set -euo pipefail

echo "DEBUG 2: set -euo pipefail"

export WORKSPACE_ROOT=$(pwd)

echo "DEBUG 3: WORKSPACE_ROOT=$WORKSPACE_ROOT"

export DEV_SSL_KEY="$WORKSPACE_ROOT/certs/key.pem"
export DEV_SSL_CERT="$WORKSPACE_ROOT/certs/cert.pem"

export VITE_LIVESTORE_SYNC_URL="http://localhost:8787"

export OTEL_EXPORTER_OTLP_ENDPOINT="http://localhost:4318"
export VITE_OTEL_EXPORTER_OTLP_ENDPOINT="${OTEL_EXPORTER_OTLP_ENDPOINT}"

export GRAFANA_ENDPOINT="http://localhost:30003"
export VITE_GRAFANA_ENDPOINT="${GRAFANA_ENDPOINT}"

# Needed until Corepack newest corepack version is released on nixpkgs
export COREPACK_INTEGRITY_KEYS=0

echo "DEBUG 4: .envrc.local exists: $(test -f ./.envrc.local && echo 'yes' || echo 'no')"

if test -f ./.envrc.local; then
    source_env ./.envrc.local
fi

echo "DEBUG 5"

if command -v nix-shell &> /dev/null
then
    cd nix
    use_flake
    cd ..
fi

echo "DEBUG 6"

# Add LiveStore CLIs to PATH
export PATH="$WORKSPACE_ROOT/scripts/bin:$PATH"

# For convenience we're also exposing executables from node_modules/.bin e.g. `vite`
export PATH="$WORKSPACE_ROOT/node_modules/.bin:$PATH"

# region-start: expo
# When building react-native on iOS, it requires `cp -X` for macOS than the one from nix.
export PATH="/bin:$PATH"

# Remove once fixed https://github.com/NixOS/nixpkgs/issues/355486
export PATH="/usr/bin:/bin:$WORKSPACE_ROOT/node_modules/.bin:$PATH"
# Unset DEVELOPER_DIR to avoid conflicts with Xcode path
unset DEVELOPER_DIR
# remove end
# region-end: expo

export LS_DEV=1
export VITE_LS_DEV=$LS_DEV

export LIVESTORE_PLAYWRIGHT_DEV_SERVER_PORT="4444"

export NODE_OPTIONS="--disable-warning=ExperimentalWarning"

# export LS_TRACE_VERBOSE="1"
# export VITE_LS_TRACE_VERBOSE="1"

current_git_hash=$(git rev-parse HEAD 2>/dev/null || echo "no-git")
last_git_hash_file="$WORKSPACE_ROOT/node_modules/.last_git_hash"

# Check if we need to initialize (either never initialized or git hash changed)
if [ ! -f "$last_git_hash_file" ] || [ "$(cat "$last_git_hash_file" 2>/dev/null)" != "$current_git_hash" ]; then
    # Install node dependencies for convenience, but only if parent is not a git repo (e.g. when cloned as a submodule)
    parent_dir=$(dirname "$PWD")
    if ! git -C "$parent_dir" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        CI=1 pnpm install
    else
        echo "parent is a git repo, skipping node dependencies installation"
    fi

    # Run an initial TS build
    mono ts

    echo "$current_git_hash" > "$last_git_hash_file"
fi

# Generate and load completions for those CLIs
source $WORKSPACE_ROOT/scripts/completions.sh
