name: Setup
description: Setup the environment for the CI workflow.
inputs:
  direnv-timeout:
    description: Timeout in seconds for direnv allow step
    required: false
    default: "300"

runs:
  using: composite
  steps:
    - name: Install Determinate Nix
      uses: DeterminateSystems/determinate-nix-action@v3

      # NOTE Flakehub cache is still faster than magic-nix-cache-action
    - name: Setup Flakehub Cache
      uses: DeterminateSystems/flakehub-cache-action@main
    # - name: Nix cache
    #   uses: DeterminateSystems/magic-nix-cache-action@main

    - name: Install and setup direnv
      shell: bash
      run: |
        set -euo pipefail

        echo "Installing direnv..."
        if ! nix profile add nixpkgs#direnv; then
          echo "::error::Failed to install direnv via Nix"
          exit 1
        fi

        echo "Verifying direnv installation..."
        if ! command -v direnv >/dev/null 2>&1; then
          echo "::error::direnv not found in PATH after installation"
          exit 1
        fi

        echo "Running direnv allow with timeout ${{ inputs.direnv-timeout }}s..."
        if ! timeout "${{ inputs.direnv-timeout }}" direnv allow 2>&1; then
          echo "::error::direnv allow failed or timed out after ${{ inputs.direnv-timeout }}s"
          exit 1
        fi

        # Check if `node_modules/.last_git_hash` exists as sanity check
        if [ ! -f "node_modules/.last_git_hash" ]; then
          echo "::error::node_modules/.last_git_hash does not exist."
          exit 1
        fi

        echo "Exporting environment variables..."
        if ! direnv export bash >> "$GITHUB_ENV"; then
          echo "::error::Failed to export environment variables"
          exit 1
        fi

        echo "Environment setup complete"
